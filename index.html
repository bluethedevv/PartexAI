<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PartexAI - AI App Builder</title>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        }

        :root {
            --primary: #7C3AED;
            --primary-dark: #6D28D9;
            --primary-light: #8B5CF6;
            --secondary: #10B981;
            --secondary-dark: #0D946E;
            --secondary-light: #34D399;
            --background: #0F0F0F;
            --background-light: #1A1A1A;
            --background-lighter: #262626;
            --surface: #1A1A1A;
            --surface-light: #262626;
            --surface-lighter: #374151;
            --text-primary: #FFFFFF;
            --text-secondary: #A1A1AA;
            --text-tertiary: #71717A;
            --border: #374151;
            --border-light: #4B5563;
            --border-lighter: #6B7280;
            --success: #10B981;
            --success-dark: #0D946E;
            --warning: #F59E0B;
            --warning-dark: #D97706;
            --error: #EF4444;
            --error-dark: #DC2626;
            --info: #3B82F6;
            --credits: #F59E0B;
            --credits-dark: #D97706;
            --gradient-primary: linear-gradient(135deg, var(--primary), var(--secondary));
            --gradient-secondary: linear-gradient(135deg, var(--primary-light), var(--secondary-light));
            --gradient-surface: linear-gradient(135deg, var(--surface), var(--surface-light));
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            --shadow-2xl: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            --radius-sm: 0.375rem;
            --radius-md: 0.5rem;
            --radius-lg: 0.75rem;
            --radius-xl: 1rem;
            --radius-2xl: 1.5rem;
            --radius-3xl: 2rem;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-fast: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-slow: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        body {
            background: var(--background);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
            line-height: 1.6;
            font-weight: 400;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 2rem;
        }

        /* Auth Screens */
        .auth-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: var(--gradient-surface);
            position: relative;
            overflow: hidden;
        }

        .auth-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(circle at 20% 80%, rgba(124, 58, 237, 0.1) 0%, transparent 50%),
                        radial-gradient(circle at 80% 20%, rgba(16, 185, 129, 0.1) 0%, transparent 50%);
            animation: backgroundShift 10s ease-in-out infinite;
        }

        .auth-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius-2xl);
            padding: 3rem;
            width: 100%;
            max-width: 28rem;
            box-shadow: var(--shadow-2xl);
            position: relative;
            z-index: 10;
            backdrop-filter: blur(20px);
            animation: cardEntrance 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .auth-logo {
            text-align: center;
            margin-bottom: 2.5rem;
        }

        .auth-logo h1 {
            font-size: 2.5rem;
            font-weight: 800;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
            letter-spacing: -0.025em;
        }

        .auth-logo p {
            color: var(--text-secondary);
            font-size: 1rem;
            font-weight: 500;
        }

        .auth-input-group {
            margin-bottom: 1.5rem;
        }

        .auth-label {
            display: block;
            color: var(--text-secondary);
            font-size: 0.875rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
            transition: var(--transition);
        }

        .auth-input {
            width: 100%;
            background: var(--surface-light);
            border: 1.5px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 1rem 1.25rem;
            color: var(--text-primary);
            font-size: 1rem;
            font-weight: 400;
            transition: var(--transition);
            outline: none;
        }

        .auth-input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.1);
            background: var(--surface-lighter);
        }

        .auth-input::placeholder {
            color: var(--text-tertiary);
        }

        .auth-btn {
            width: 100%;
            background: var(--gradient-primary);
            color: white;
            border: none;
            border-radius: var(--radius-lg);
            padding: 1rem 1.5rem;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            margin-bottom: 1.5rem;
            position: relative;
            overflow: hidden;
        }

        .auth-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: var(--transition-slow);
        }

        .auth-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .auth-btn:hover::before {
            left: 100%;
        }

        .auth-btn:active {
            transform: translateY(0);
        }

        .auth-toggle {
            text-align: center;
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        .auth-toggle a {
            color: var(--primary);
            text-decoration: none;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
        }

        .auth-toggle a:hover {
            color: var(--primary-light);
        }

        .error-message {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid var(--error);
            color: var(--error);
            padding: 1rem 1.25rem;
            border-radius: var(--radius-lg);
            margin-bottom: 1.5rem;
            font-size: 0.875rem;
            font-weight: 500;
            display: none;
            animation: shake 0.5s ease-in-out;
        }

        /* Main App */
        .app-container {
            display: none;
            min-height: 100vh;
            background: var(--background);
            position: relative;
        }

        .app-container::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(circle at 15% 50%, rgba(124, 58, 237, 0.03) 0%, transparent 50%),
                        radial-gradient(circle at 85% 30%, rgba(16, 185, 129, 0.03) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }

        /* Header */
        .header {
            background: rgba(26, 26, 26, 0.8);
            border-bottom: 1px solid var(--border);
            padding: 1rem 0;
            position: sticky;
            top: 0;
            z-index: 1000;
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
        }

        .nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 1.75rem;
            font-weight: 800;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: -0.025em;
        }

        .nav-links {
            display: flex;
            gap: 2.5rem;
            align-items: center;
        }

        .nav-link {
            color: var(--text-secondary);
            text-decoration: none;
            font-weight: 500;
            font-size: 0.95rem;
            transition: var(--transition);
            position: relative;
            padding: 0.5rem 0;
        }

        .nav-link::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 0;
            height: 2px;
            background: var(--gradient-primary);
            transition: var(--transition);
            border-radius: 2px;
        }

        .nav-link:hover {
            color: var(--text-primary);
        }

        .nav-link:hover::after {
            width: 100%;
        }

        .nav-link.active {
            color: var(--text-primary);
        }

        .nav-link.active::after {
            width: 100%;
        }

        .user-section {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }

        .credits-badge {
            background: var(--credits);
            color: #000;
            padding: 0.75rem 1.25rem;
            border-radius: 2rem;
            font-weight: 700;
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            box-shadow: var(--shadow-md);
            transition: var(--transition);
            border: 2px solid transparent;
        }

        .credits-badge:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
            border-color: var(--credits-dark);
        }

        .avatar {
            width: 3rem;
            height: 3rem;
            border-radius: 50%;
            background: var(--gradient-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            color: white;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: var(--shadow-md);
            border: 2px solid transparent;
        }

        .avatar:hover {
            transform: scale(1.05);
            box-shadow: var(--shadow-lg);
            border-color: var(--primary-light);
        }

        /* Main Content */
        .main-content {
            display: grid;
            grid-template-columns: 1fr 26rem;
            gap: 3rem;
            padding: 3rem 0;
            min-height: calc(100vh - 5rem);
            position: relative;
            z-index: 1;
        }

        /* Chat Section */
        .chat-section {
            background: var(--surface);
            border-radius: var(--radius-2xl);
            border: 1px solid var(--border);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: var(--shadow-xl);
            transition: var(--transition);
        }

        .chat-section:hover {
            box-shadow: var(--shadow-2xl);
        }

        .chat-header {
            padding: 2rem 2.5rem;
            border-bottom: 1px solid var(--border);
            background: var(--surface-light);
        }

        .chat-header h2 {
            font-size: 1.75rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .chat-header p {
            color: var(--text-secondary);
            font-size: 1rem;
            font-weight: 400;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 2rem 2.5rem;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            max-height: 35rem;
            scroll-behavior: smooth;
        }

        .chat-messages::-webkit-scrollbar {
            width: 6px;
        }

        .chat-messages::-webkit-scrollbar-track {
            background: var(--surface-light);
            border-radius: 3px;
        }

        .chat-messages::-webkit-scrollbar-thumb {
            background: var(--border-light);
            border-radius: 3px;
        }

        .chat-messages::-webkit-scrollbar-thumb:hover {
            background: var(--border-lighter);
        }

        .message {
            display: flex;
            gap: 1rem;
            animation: messageSlide 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .message.user {
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 2.75rem;
            height: 2.75rem;
            border-radius: 50%;
            background: var(--gradient-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.875rem;
            font-weight: 700;
            flex-shrink: 0;
            box-shadow: var(--shadow-md);
            transition: var(--transition);
        }

        .message.user .message-avatar {
            background: var(--gradient-secondary);
        }

        .message-avatar:hover {
            transform: scale(1.1);
        }

        .message-content {
            background: var(--surface-light);
            padding: 1.25rem 1.5rem;
            border-radius: var(--radius-xl);
            max-width: 75%;
            border: 1px solid var(--border);
            box-shadow: var(--shadow-sm);
            animation: messagePop 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            transition: var(--transition);
        }

        .message-content:hover {
            box-shadow: var(--shadow-md);
        }

        .message.user .message-content {
            background: var(--primary);
            color: white;
            border: none;
            box-shadow: var(--shadow-md);
        }

        .message.user .message-content:hover {
            box-shadow: var(--shadow-lg);
        }

        .message-text {
            line-height: 1.6;
            font-size: 0.95rem;
            font-weight: 400;
        }

        .message-actions {
            display: flex;
            gap: 0.75rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }

        .action-btn {
            background: var(--surface);
            border: 1.5px solid var(--border);
            color: var(--text-primary);
            padding: 0.75rem 1.25rem;
            border-radius: 2rem;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .action-btn:hover {
            background: var(--surface-light);
            border-color: var(--primary);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .action-btn.credits {
            background: var(--credits);
            color: #000;
            border: none;
            font-weight: 700;
        }

        .action-btn.credits:hover {
            background: var(--credits-dark);
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .action-btn.secondary {
            background: transparent;
            border-color: var(--secondary);
            color: var(--secondary);
        }

        .action-btn.secondary:hover {
            background: var(--secondary);
            color: white;
        }

        .chat-input-container {
            padding: 2rem 2.5rem;
            border-top: 1px solid var(--border);
            background: var(--surface-light);
        }

        .chat-input {
            display: flex;
            gap: 1rem;
            align-items: flex-end;
        }

        .input-field {
            flex: 1;
            background: var(--surface);
            border: 1.5px solid var(--border);
            border-radius: var(--radius-xl);
            padding: 1.25rem 1.5rem;
            color: var(--text-primary);
            font-size: 1rem;
            font-weight: 400;
            resize: none;
            min-height: 4rem;
            max-height: 8rem;
            transition: var(--transition);
            outline: none;
            line-height: 1.5;
        }

        .input-field:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.1);
            background: var(--surface-lighter);
        }

        .input-field::placeholder {
            color: var(--text-tertiary);
        }

        .send-btn {
            background: var(--gradient-primary);
            color: white;
            border: none;
            border-radius: var(--radius-xl);
            padding: 1.25rem 2rem;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            box-shadow: var(--shadow-md);
        }

        .send-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .send-btn:active {
            transform: translateY(0);
        }

        .send-btn:disabled {
            background: var(--border);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* Custom Input Section */
        .custom-input-section {
            background: var(--surface-light);
            border-radius: var(--radius-xl);
            padding: 2rem;
            margin: 1.5rem 2.5rem;
            border: 1px solid var(--border);
            display: none;
            animation: slideDown 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .custom-input-section h4 {
            margin-bottom: 1.5rem;
            color: var(--text-primary);
            font-size: 1.25rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .custom-input-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1.25rem;
        }

        .custom-input-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .custom-label {
            color: var(--text-secondary);
            font-size: 0.875rem;
            font-weight: 500;
        }

        .custom-input {
            background: var(--surface);
            border: 1.5px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 1rem 1.25rem;
            color: var(--text-primary);
            font-size: 0.95rem;
            transition: var(--transition);
            outline: none;
        }

        .custom-input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.1);
        }

        .custom-select {
            background: var(--surface);
            border: 1.5px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 1rem 1.25rem;
            color: var(--text-primary);
            font-size: 0.95rem;
            cursor: pointer;
            transition: var(--transition);
            outline: none;
        }

        .custom-select:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.1);
        }

        .color-input-group {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .color-picker {
            width: 3.5rem;
            height: 3.5rem;
            border: none;
            border-radius: var(--radius-lg);
            cursor: pointer;
            background: var(--surface);
            border: 1.5px solid var(--border);
            transition: var(--transition);
        }

        .color-picker:hover {
            transform: scale(1.05);
        }

        .color-picker:focus {
            outline: 2px solid var(--primary);
        }

        .feature-toggle {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin: 1rem 0;
            padding: 1rem 0;
            border-bottom: 1px solid var(--border-light);
        }

        .feature-toggle:last-child {
            border-bottom: none;
        }

        .toggle-label {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            color: var(--text-primary);
            font-size: 0.95rem;
            font-weight: 500;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 3.5rem;
            height: 2rem;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--border);
            transition: var(--transition);
            border-radius: 2rem;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 1.5rem;
            width: 1.5rem;
            left: 0.25rem;
            bottom: 0.25rem;
            background-color: white;
            transition: var(--transition);
            border-radius: 50%;
            box-shadow: var(--shadow-sm);
        }

        input:checked + .toggle-slider {
            background-color: var(--primary);
        }

        input:checked + .toggle-slider:before {
            transform: translateX(1.5rem);
        }

        /* Phone Preview */
        .phone-preview {
            background: var(--surface);
            border-radius: var(--radius-2xl);
            border: 1px solid var(--border);
            padding: 2.5rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            box-shadow: var(--shadow-xl);
            transition: var(--transition);
        }

        .phone-preview:hover {
            box-shadow: var(--shadow-2xl);
        }

        .phone-device {
            width: 20rem;
            height: 42rem;
            background: #1a1a1a;
            border-radius: 3rem;
            padding: 1.5rem;
            position: relative;
            border: 0.75rem solid #2a2a2a;
            box-shadow: var(--shadow-2xl);
            transition: var(--transition);
        }

        .phone-device:hover {
            transform: translateY(-5px);
        }

        .phone-screen {
            width: 100%;
            height: 100%;
            background: white;
            border-radius: 2rem;
            overflow: hidden;
            position: relative;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.1);
        }

        .app-preview {
            width: 100%;
            height: 100%;
            background: var(--surface);
            overflow-y: auto;
            position: relative;
        }

        .generated-app {
            width: 100%;
            height: 100%;
            background: white;
            color: #000;
            overflow-y: auto;
            font-family: 'Inter', sans-serif;
            transform-origin: top left;
            transition: var(--transition-slow);
        }

        .preview-header {
            text-align: center;
            margin-bottom: 2rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid var(--border);
            background: linear-gradient(135deg, #7C3AED, #10B981);
            color: white;
            padding: 3rem 2rem;
        }

        .preview-header h4 {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .preview-header p {
            opacity: 0.9;
            font-size: 0.95rem;
        }

        .preview-content {
            padding: 2rem;
            display: flex;
            flex-direction: column;
            gap: 1.25rem;
        }

        .preview-item {
            background: var(--surface-light);
            padding: 1.5rem;
            border-radius: var(--radius-lg);
            border: 1px solid var(--border);
            transition: var(--transition);
            animation: itemSlide 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .preview-item:hover {
            transform: translateX(5px);
            box-shadow: var(--shadow-md);
        }

        .preview-placeholder {
            background: linear-gradient(90deg, var(--surface-light), var(--border), var(--surface-light));
            background-size: 200% 100%;
            animation: loading 2s ease-in-out infinite;
            height: 6rem;
            border-radius: var(--radius-lg);
            border: 1px solid var(--border);
        }

        /* Progress Section */
        .progress-container {
            margin-top: 2.5rem;
            width: 100%;
            display: none;
            animation: slideUp 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.25rem;
        }

        .progress-header h4 {
            color: var(--text-primary);
            font-size: 1.1rem;
            font-weight: 600;
        }

        .progress-text {
            color: var(--primary);
            font-size: 1rem;
            font-weight: 700;
        }

        .progress-bar {
            height: 0.75rem;
            background: var(--surface-light);
            border-radius: 1rem;
            overflow: hidden;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }

        .progress-fill {
            height: 100%;
            background: var(--gradient-primary);
            border-radius: 1rem;
            transition: var(--transition-slow);
            width: 0%;
            position: relative;
            overflow: hidden;
        }

        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: shimmer 2s infinite;
        }

        /* History Section */
        .history-section {
            background: var(--surface);
            border-radius: var(--radius-2xl);
            border: 1px solid var(--border);
            padding: 2.5rem;
            margin-top: 2rem;
            max-height: 25rem;
            overflow-y: auto;
            box-shadow: var(--shadow-xl);
            transition: var(--transition);
        }

        .history-section:hover {
            box-shadow: var(--shadow-2xl);
        }

        .history-section::-webkit-scrollbar {
            width: 6px;
        }

        .history-section::-webkit-scrollbar-track {
            background: var(--surface-light);
            border-radius: 3px;
        }

        .history-section::-webkit-scrollbar-thumb {
            background: var(--border-light);
            border-radius: 3px;
        }

        .history-section::-webkit-scrollbar-thumb:hover {
            background: var(--border-lighter);
        }

        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .history-header h3 {
            color: var(--text-primary);
            font-size: 1.25rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .history-item {
            background: var(--surface-light);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            margin-bottom: 1rem;
            cursor: pointer;
            transition: var(--transition);
            animation: itemSlide 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .history-item:hover {
            border-color: var(--primary);
            transform: translateX(5px);
            box-shadow: var(--shadow-md);
        }

        .history-item h4 {
            color: var(--text-primary);
            margin-bottom: 0.5rem;
            font-size: 1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .history-item p {
            color: var(--text-secondary);
            font-size: 0.875rem;
            margin-bottom: 0.5rem;
        }

        .history-date {
            color: var(--text-tertiary);
            font-size: 0.75rem;
            margin-top: 0.75rem;
        }

        /* Download Button */
        .download-btn {
            background: var(--success);
            color: white;
            border: none;
            border-radius: var(--radius-lg);
            padding: 1.25rem 2rem;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            margin-top: 1.5rem;
            width: 100%;
            display: none;
            box-shadow: var(--shadow-md);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .download-btn:hover {
            background: var(--success-dark);
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .download-btn:active {
            transform: translateY(0);
        }

        /* Scale Controls */
        .scale-controls {
            display: flex;
            gap: 0.75rem;
            margin-top: 1.5rem;
            width: 100%;
            display: none;
            animation: slideUp 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .scale-btn {
            flex: 1;
            background: var(--surface-light);
            border: 1.5px solid var(--border);
            color: var(--text-primary);
            padding: 0.75rem 1rem;
            border-radius: var(--radius-lg);
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 600;
            transition: var(--transition);
            text-align: center;
        }

        .scale-btn:hover {
            background: var(--surface-lighter);
            border-color: var(--primary-light);
        }

        .scale-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
            box-shadow: var(--shadow-md);
        }

        /* Animations */
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes messageSlide {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes messagePop {
            0% {
                transform: scale(0.8);
                opacity: 0;
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        @keyframes itemSlide {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes cardEntrance {
            0% {
                opacity: 0;
                transform: scale(0.8) translateY(50px);
            }
            100% {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        @keyframes backgroundShift {
            0%, 100% {
                transform: translate(0, 0) scale(1);
            }
            50% {
                transform: translate(-10px, -10px) scale(1.02);
            }
        }

        @keyframes loading {
            0% {
                background-position: -200% 0;
            }
            100% {
                background-position: 200% 0;
            }
        }

        @keyframes shimmer {
            0% {
                left: -100%;
            }
            100% {
                left: 100%;
            }
        }

        @keyframes shake {
            0%, 100% {
                transform: translateX(0);
            }
            10%, 30%, 50%, 70%, 90% {
                transform: translateX(-5px);
            }
            20%, 40%, 60%, 80% {
                transform: translateX(5px);
            }
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.05);
            }
        }

        /* Responsive Design */
        @media (max-width: 1200px) {
            .main-content {
                grid-template-columns: 1fr;
                gap: 2rem;
            }
            
            .phone-preview {
                display: none;
            }
            
            .container {
                padding: 0 1.5rem;
            }
        }

        @media (max-width: 768px) {
            .nav-links {
                display: none;
            }
            
            .auth-card {
                padding: 2rem;
                margin: 1rem;
            }
            
            .chat-header,
            .chat-messages,
            .chat-input-container {
                padding: 1.5rem;
            }
            
            .custom-input-row {
                grid-template-columns: 1fr;
            }
            
            .phone-device {
                width: 18rem;
                height: 38rem;
            }
        }

        @media (max-width: 480px) {
            .container {
                padding: 0 1rem;
            }
            
            .auth-card {
                padding: 1.5rem;
            }
            
            .chat-section {
                border-radius: var(--radius-xl);
            }
            
            .message-content {
                max-width: 85%;
            }
            
            .phone-device {
                width: 16rem;
                height: 34rem;
                padding: 1rem;
            }
        }
    </style>
</head>
<body>
    <!-- Auth Screens -->
    <div id="authContainer" class="auth-container">
        <div class="auth-card">
            <div class="auth-logo">
                <h1>PartexAI</h1>
                <p>AI App Builder Platform</p>
            </div>
            
            <!-- Login -->
            <div id="loginDiv">
                <div id="loginError" class="error-message"></div>
                <div class="auth-input-group">
                    <label class="auth-label" for="loginEmail">Email Address</label>
                    <input type="email" id="loginEmail" class="auth-input" placeholder="Enter your email" value="demo@partexai.com">
                </div>
                <div class="auth-input-group">
                    <label class="auth-label" for="loginPassword">Password</label>
                    <input type="password" id="loginPassword" class="auth-input" placeholder="Enter your password" value="demopassword123">
                </div>
                <button class="auth-btn" onclick="login()">
                    <span>Sign In</span>
                </button>
                <div class="auth-toggle">
                    <p>Don't have an account? <a onclick="showRegister()">Create one here</a></p>
                </div>
            </div>

            <!-- Register -->
            <div id="registerDiv" style="display: none;">
                <div id="registerError" class="error-message"></div>
                <div class="auth-input-group">
                    <label class="auth-label" for="registerUsername">Username</label>
                    <input type="text" id="registerUsername" class="auth-input" placeholder="Choose a username">
                </div>
                <div class="auth-input-group">
                    <label class="auth-label" for="registerEmail">Email Address</label>
                    <input type="email" id="registerEmail" class="auth-input" placeholder="Enter your email">
                </div>
                <div class="auth-input-group">
                    <label class="auth-label" for="registerPassword">Password</label>
                    <input type="password" id="registerPassword" class="auth-input" placeholder="Create a password">
                </div>
                <button class="auth-btn" onclick="register()">
                    <span>Create Account</span>
                </button>
                <div class="auth-toggle">
                    <p>Already have an account? <a onclick="showLogin()">Sign in here</a></p>
                </div>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="appContainer" class="app-container">
        <!-- Header -->
        <header class="header">
            <div class="container">
                <nav class="nav">
                    <div class="logo">PartexAI</div>
                    <div class="nav-links">
                        <a href="#" class="nav-link active" onclick="showSection('dashboard')">Dashboard</a>
                        <a href="#" class="nav-link" onclick="showSection('projects')">Projects</a>
                        <a href="#" class="nav-link" onclick="showSection('templates')">Templates</a>
                        <a href="#" class="nav-link" onclick="showSection('documentation')">Documentation</a>
                        <a href="#" class="nav-link" onclick="showSection('support')">Support</a>
                    </div>
                    <div class="user-section">
                        <div class="credits-badge" id="creditsDisplay">
                            <span>‚ö°</span>
                            <span id="creditsCount">400</span> Credits
                        </div>
                        <div class="avatar" id="userAvatar" onclick="logout()">U</div>
                    </div>
                </nav>
            </div>
        </header>

        <!-- Main Content -->
        <div class="container">
            <div class="main-content">
                <!-- Chat Section -->
                <section class="chat-section">
                    <div class="chat-header">
                        <h2>Ask PartexAI...</h2>
                        <p>Describe your app or ask anything - AI builds it step by step</p>
                    </div>

                    <div class="chat-messages" id="chatMessages">
                        <div class="message">
                            <div class="message-avatar">AI</div>
                            <div class="message-content">
                                <p class="message-text">üëã Hello! I'm PartexAI. What kind of app would you like to create today?</p>
                                <p class="message-text"><strong>‚ö° Cost: 40 Credits per app | 5 Credits for normal chat</strong></p>
                                <div class="message-actions">
                                    <button class="action-btn credits" onclick="selectTemplate('social')">
                                        <span>üì±</span>
                                        <span>Social Media App</span>
                                    </button>
                                    <button class="action-btn credits" onclick="selectTemplate('recipe')">
                                        <span>üç≥</span>
                                        <span>Recipe App</span>
                                    </button>
                                    <button class="action-btn credits" onclick="selectTemplate('news')">
                                        <span>üì∞</span>
                                        <span>News Reader</span>
                                    </button>
                                    <button class="action-btn credits" onclick="selectTemplate('weather')">
                                        <span>üå§Ô∏è</span>
                                        <span>Weather App</span>
                                    </button>
                                    <button class="action-btn secondary" onclick="showCustomInput()">
                                        <span>‚öôÔ∏è</span>
                                        <span>Custom App</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Custom Input Section -->
                    <div class="custom-input-section" id="customInputSection">
                        <h4>üé® Customize Your App</h4>
                        <div class="custom-input-row">
                            <div class="custom-input-group">
                                <label class="custom-label">App Name</label>
                                <input type="text" id="appName" class="custom-input" placeholder="My Awesome App" value="My Awesome App">
                            </div>
                            <div class="custom-input-group">
                                <label class="custom-label">App Type</label>
                                <select id="appType" class="custom-select">
                                    <option value="social">Social Media</option>
                                    <option value="business">Business</option>
                                    <option value="portfolio">Portfolio</option>
                                    <option value="ecommerce">E-commerce</option>
                                    <option value="blog">Blog</option>
                                    <option value="dashboard">Dashboard</option>
                                    <option value="education">Education</option>
                                    <option value="health">Health & Fitness</option>
                                    <option value="weather">Weather</option>
                                </select>
                            </div>
                        </div>
                        <div class="custom-input-row">
                            <div class="custom-input-group">
                                <label class="custom-label">Primary Color</label>
                                <div class="color-input-group">
                                    <input type="text" id="primaryColor" class="custom-input" placeholder="#7C3AED" value="#7C3AED">
                                    <input type="color" id="colorPicker" class="color-picker" value="#7C3AED">
                                </div>
                            </div>
                            <div class="custom-input-group">
                                <label class="custom-label">Layout Type</label>
                                <select id="layoutType" class="custom-select">
                                    <option value="modern">Modern Layout</option>
                                    <option value="minimal">Minimal Layout</option>
                                    <option value="grid">Grid Layout</option>
                                    <option value="card">Card Layout</option>
                                    <option value="magazine">Magazine Layout</option>
                                </select>
                            </div>
                        </div>
                        <div class="custom-input-row">
                            <div class="custom-input-group">
                                <label class="custom-label">Theme</label>
                                <select id="themeType" class="custom-select">
                                    <option value="light">Light Theme</option>
                                    <option value="dark">Dark Theme</option>
                                    <option value="gradient">Gradient Theme</option>
                                    <option value="professional">Professional</option>
                                </select>
                            </div>
                            <div class="custom-input-group">
                                <label class="custom-label">Framework</label>
                                <select id="frameworkType" class="custom-select">
                                    <option value="vanilla">Vanilla HTML/CSS/JS</option>
                                    <option value="bootstrap">Bootstrap</option>
                                    <option value="tailwind">Tailwind CSS</option>
                                    <option value="material">Material Design</option>
                                </select>
                            </div>
                        </div>
                        <div class="feature-toggle">
                            <div class="toggle-label">
                                <span>üåô</span>
                                <span>Dark Mode</span>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="darkModeToggle" checked>
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        <div class="feature-toggle">
                            <div class="toggle-label">
                                <span>üì±</span>
                                <span>Responsive Design</span>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="responsiveToggle" checked>
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        <div class="feature-toggle">
                            <div class="toggle-label">
                                <span>‚ú®</span>
                                <span>Animations</span>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="animationsToggle" checked>
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        <div class="feature-toggle">
                            <div class="toggle-label">
                                <span>üîç</span>
                                <span>SEO Optimized</span>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="seoToggle" checked>
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        <button class="action-btn credits" onclick="generateCustomApp()" style="width: 100%; margin-top: 1.5rem;">
                            <span>üöÄ</span>
                            <span>Generate Custom App (40‚ö°)</span>
                        </button>
                    </div>

                    <div class="chat-input-container">
                        <div class="chat-input">
                            <textarea 
                                class="input-field" 
                                id="messageInput" 
                                placeholder="Describe your app idea or ask anything... (40‚ö° for apps, 5‚ö° for chat)"
                                rows="3"
                            ></textarea>
                            <button class="send-btn" id="sendBtn" onclick="sendMessage()">
                                <span>Send</span>
                                <span>üöÄ</span>
                            </button>
                        </div>
                    </div>
                </section>

                <!-- Right Panel -->
                <div class="right-panel">
                    <!-- Phone Preview -->
                    <section class="phone-preview">
                        <h3 style="margin-bottom: 1.5rem; text-align: center; color: var(--text-primary);">üì± Live Preview</h3>
                        <div class="phone-device">
                            <div class="phone-screen">
                                <div class="app-preview" id="appPreview">
                                    <div class="generated-app" id="generatedApp">
                                        <div class="preview-header">
                                            <h4>Your App Preview</h4>
                                            <p>App content will appear here once generated</p>
                                        </div>
                                        <div class="preview-content">
                                            <div class="preview-placeholder"></div>
                                            <div class="preview-placeholder"></div>
                                            <div class="preview-placeholder"></div>
                                            <div class="preview-placeholder"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Progress Section -->
                        <div class="progress-container" id="progressSection">
                            <div class="progress-header">
                                <h4>AI Building Your App...</h4>
                                <span class="progress-text" id="progressText">0%</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" id="progressFill"></div>
                            </div>
                        </div>

                        <!-- Scale Controls -->
                        <div class="scale-controls" id="scaleControls">
                            <button class="scale-btn active" onclick="setScale(1)">100%</button>
                            <button class="scale-btn" onclick="setScale(0.85)">85%</button>
                            <button class="scale-btn" onclick="setScale(0.7)">70%</button>
                            <button class="scale-btn" onclick="setScale(0.55)">55%</button>
                        </div>

                        <!-- Download Button -->
                        <button class="download-btn" id="downloadBtn" onclick="downloadApp()">
                            <span>üì•</span>
                            <span>Download App</span>
                        </button>
                    </section>

                    <!-- History Section -->
                    <section class="history-section">
                        <div class="history-header">
                            <h3>üìö Project History</h3>
                            <button class="action-btn secondary" onclick="clearHistory()">
                                <span>Clear</span>
                            </button>
                        </div>
                        <div id="historyList">
                            <div class="history-item" onclick="loadExampleProject()">
                                <h4>üì± Social Media Template</h4>
                                <p>Modern social media app with dark theme</p>
                                <div class="history-date">Example Project</div>
                            </div>
                            <p style="color: var(--text-secondary); text-align: center; margin-top: 1rem; font-size: 0.875rem;">
                                Your generated projects will appear here
                            </p>
                        </div>
                    </section>
                </div>
            </div>
        </div>
    </div>

    <script>
        // =============================================
        // FIREBASE CONFIGURATION & INITIALIZATION
        // =============================================
        const firebaseConfig = {
            apiKey: "AIzaSyCC3sXBJl3ej2lgUBbi2vh_YjJc-P9q2xQ",
            authDomain: "partexai.firebaseapp.com",
            databaseURL: "https://partexai-default-rtdb.firebaseio.com",
            projectId: "partexai",
            storageBucket: "partexai.firebasestorage.app",
            messagingSenderId: "539986724179",
            appId: "1:539986724179:web:3f0bfc9cb124305d4b8da6"
        };

        // Initialize Firebase
        try {
            firebase.initializeApp(firebaseConfig);
            console.log("üî• Firebase initialized successfully");
        } catch (error) {
            console.log("‚ÑπÔ∏è Firebase already initialized");
        }
        
        const auth = firebase.auth();
        const database = firebase.database();

        // =============================================
        // APP CONSTANTS & CONFIGURATION
        // =============================================
        const APP_COST = 40;
        const CHAT_COST = 5;
        const DAILY_CREDITS = 400;
        
        // =============================================
        // GLOBAL STATE MANAGEMENT
        // =============================================
        let userCredits = 400;
        let currentUser = null;
        let userHistory = [];
        let currentGeneratedApp = null;
        let currentScale = 1;
        let isProcessing = false;

        // =============================================
        // AUTHENTICATION SYSTEM
        // =============================================
        function showRegister() {
            document.getElementById('loginDiv').style.display = 'none';
            document.getElementById('registerDiv').style.display = 'block';
            document.getElementById('registerError').style.display = 'none';
        }

        function showLogin() {
            document.getElementById('registerDiv').style.display = 'none';
            document.getElementById('loginDiv').style.display = 'block';
            document.getElementById('loginError').style.display = 'none';
        }

        function showError(type, message) {
            const errorDiv = document.getElementById(type + 'Error');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }

        async function register() {
            const username = document.getElementById('registerUsername').value.trim();
            const email = document.getElementById('registerEmail').value.trim();
            const password = document.getElementById('registerPassword').value;
            
            if (!username || !email || !password) {
                showError('register', '‚ùå Please fill in all fields');
                return;
            }

            if (password.length < 6) {
                showError('register', '‚ùå Password must be at least 6 characters long');
                return;
            }

            try {
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                const user = userCredential.user;
                
                // Save user data to database
                await database.ref('users/' + user.uid).set({
                    username: username,
                    email: email,
                    credits: DAILY_CREDITS,
                    createdAt: new Date().toISOString(),
                    lastReset: new Date().toDateString(),
                    history: [],
                    preferences: {
                        theme: 'dark',
                        notifications: true
                    }
                });

                console.log('‚úÖ User registered successfully:', user);
                showError('register', '‚úÖ Account created successfully! Redirecting...');
                
                setTimeout(() => {
                    document.getElementById('authContainer').style.display = 'none';
                    document.getElementById('appContainer').style.display = 'block';
                }, 1500);
                
            } catch (error) {
                console.error('‚ùå Registration error:', error);
                let errorMessage = 'Registration failed: ';
                
                switch (error.code) {
                    case 'auth/email-already-in-use':
                        errorMessage += 'Email is already registered';
                        break;
                    case 'auth/invalid-email':
                        errorMessage += 'Invalid email address';
                        break;
                    case 'auth/weak-password':
                        errorMessage += 'Password is too weak';
                        break;
                    default:
                        errorMessage += error.message;
                }
                
                showError('register', errorMessage);
            }
        }

        async function login() {
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;
            
            if (!email || !password) {
                showError('login', '‚ùå Please enter both email and password');
                return;
            }

            try {
                await auth.signInWithEmailAndPassword(email, password);
            } catch (error) {
                console.error('‚ùå Login error:', error);
                let errorMessage = 'Login failed: ';
                
                switch (error.code) {
                    case 'auth/user-not-found':
                        errorMessage += 'No account found with this email';
                        break;
                    case 'auth/wrong-password':
                        errorMessage += 'Incorrect password';
                        break;
                    case 'auth/invalid-email':
                        errorMessage += 'Invalid email address';
                        break;
                    default:
                        errorMessage += error.message;
                }
                
                showError('login', errorMessage);
            }
        }

        function logout() {
            auth.signOut();
        }

        // Auth state listener
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('userAvatar').textContent = user.email.charAt(0).toUpperCase();
                await loadUserData();
                document.getElementById('authContainer').style.display = 'none';
                document.getElementById('appContainer').style.display = 'block';
                console.log('‚úÖ User signed in:', user.email);
            } else {
                currentUser = null;
                document.getElementById('authContainer').style.display = 'flex';
                document.getElementById('appContainer').style.display = 'none';
                console.log('‚úÖ User signed out');
            }
        });

        // =============================================
        // USER DATA MANAGEMENT
        // =============================================
        async function loadUserData() {
            if (!currentUser) return;
            
            try {
                const userRef = database.ref('users/' + currentUser.uid);
                const snapshot = await userRef.once('value');
                const userData = snapshot.val();
                
                if (userData) {
                    // Check daily credit reset
                    const today = new Date().toDateString();
                    if (userData.lastReset !== today) {
                        userCredits = DAILY_CREDITS;
                        await userRef.update({
                            credits: DAILY_CREDITS,
                            lastReset: today
                        });
                    } else {
                        userCredits = userData.credits || DAILY_CREDITS;
                    }
                    
                    // Load history
                    userHistory = userData.history || [];
                    updateHistoryDisplay();
                    updateCreditsDisplay();
                }
            } catch (error) {
                console.error('‚ùå Error loading user data:', error);
            }
        }

        async function updateCredits(change) {
            if (!currentUser) return;
            
            userCredits += change;
            try {
                await database.ref('users/' + currentUser.uid).update({
                    credits: userCredits
                });
                updateCreditsDisplay();
            } catch (error) {
                console.error('‚ùå Error updating credits:', error);
            }
        }

        function updateCreditsDisplay() {
            const creditsElement = document.getElementById('creditsCount');
            creditsElement.textContent = userCredits;
            
            // Add animation when credits change
            creditsElement.style.transform = 'scale(1.1)';
            setTimeout(() => {
                creditsElement.style.transform = 'scale(1)';
            }, 300);
        }

        // =============================================
        // NAVIGATION SYSTEM
        // =============================================
        function showSection(section) {
            // Update active nav link
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Show section content
            const sections = ['dashboard', 'projects', 'templates', 'documentation', 'support'];
            sections.forEach(sec => {
                const element = document.getElementById(sec + 'Section');
                if (element) element.style.display = 'none';
            });
            
            const targetSection = document.getElementById(section + 'Section');
            if (targetSection) {
                targetSection.style.display = 'block';
            } else {
                // For now, just show a message
                addMessage(`üîß ${section.charAt(0).toUpperCase() + section.slice(1)} section is under development. Coming soon!`, 'ai');
            }
        }

        // =============================================
        // AI INTEGRATION - COMPLETELY FIXED VERSION
        // =============================================
        async function callGeminiAI(prompt, isAppRequest = false) {
            if (isProcessing) {
                return "‚è≥ Please wait for the current request to complete...";
            }
            
            isProcessing = true;
            
            try {
                console.log('üöÄ Calling AI...', { isAppRequest, promptLength: prompt.length });
                
                if (isAppRequest) {
                    // For app generation, use enhanced template system
                    return await generateEnhancedApp(prompt);
                } else {
                    // For chat, use intelligent response system
                    return await generateChatResponse(prompt);
                }
            } catch (error) {
                console.error('‚ùå AI Error:', error);
                return isAppRequest ? generateFallbackApp(prompt) : "‚ùå I apologize, but I'm experiencing technical difficulties. Please try again in a moment.";
            } finally {
                isProcessing = false;
            }
        }

        async function generateChatResponse(prompt) {
            // Intelligent response mapping with context awareness
            const lowerPrompt = prompt.toLowerCase().trim();
            
            // Greetings and basic interactions
            if (lowerPrompt.match(/(hello|hi|hey|greetings|good morning|good afternoon)/)) {
                return "üëã Hello! I'm PartexAI, your intelligent app development assistant. How can I help you create something amazing today?";
            }
            
            if (lowerPrompt.includes('how are you')) {
                return "I'm functioning optimally and ready to help you build incredible apps! What project are you thinking about? üöÄ";
            }
            
            if (lowerPrompt.includes('thank')) {
                return "You're welcome! I'm always happy to help. Feel free to ask me anything else about app development or request a new app creation! ‚ú®";
            }
            
            // App development questions
            if (lowerPrompt.includes('what can you do') || lowerPrompt.includes('capabilities')) {
                return `üéØ **My Capabilities:**

üöÄ **App Creation** (40 credits)
‚Ä¢ Complete web applications
‚Ä¢ Responsive mobile-friendly designs
‚Ä¢ Modern UI/UX with animations
‚Ä¢ Custom functionality based on your needs

üí¨ **Chat Assistance** (5 credits)
‚Ä¢ App development guidance
‚Ä¢ Code explanations
‚Ä¢ Design recommendations
‚Ä¢ Technical support

üì± **App Types I Can Build:**
‚Ä¢ Social Media Platforms
‚Ä¢ E-commerce Stores
‚Ä¢ Business Websites
‚Ä¢ Portfolio Sites
‚Ä¢ Blogs & News Sites
‚Ä¢ Dashboards & Analytics
‚Ä¢ Educational Platforms
‚Ä¢ Health & Fitness Apps
‚Ä¢ Weather Applications

üí° **Just describe what you need, and I'll handle the rest!**`;
            }
            
            if (lowerPrompt.includes('credit') || lowerPrompt.includes('cost') || lowerPrompt.includes('price')) {
                return `üí∞ **Credit System:**

‚ö° **Daily Allocation:** 400 credits
üîÑ **Reset:** Every 24 hours

üéØ **Costs:**
‚Ä¢ **App Generation:** 40 credits
‚Ä¢ **Chat Questions:** 5 credits

üì± **What you get with app generation:**
‚Ä¢ Complete HTML/CSS/JS application
‚Ä¢ Responsive design
‚Ä¢ Modern UI/UX
‚Ä¢ Ready-to-use code
‚Ä¢ Downloadable file

üí° **Pro Tip:** You can create up to 10 apps per day with your daily credits!`;
            }
            
            if (lowerPrompt.includes('template') || lowerPrompt.includes('example')) {
                return `üìã **Available Templates:**

1. **üì± Social Media App** - Posts, likes, comments, stories
2. **üç≥ Recipe App** - Categories, favorites, shopping list
3. **üì∞ News Reader** - Personalized feeds, bookmarks
4. **üå§Ô∏è Weather App** - Forecast, animations, city search
5. **üõí E-commerce Store** - Products, cart, checkout
6. **üíº Business Website** - Services, portfolio, contact
7. **üé® Portfolio Site** - Projects, skills, testimonials
8. **üìä Dashboard** - Analytics, charts, metrics

üí° **Or describe your custom app idea - I can build anything!**`;
            }
            
            // Default intelligent response
            return `ü§î I understand you're asking about "${prompt}". 

As an AI app development specialist, I can help you with:

üéØ **App Development:** Create complete web applications tailored to your needs
üí° **Technical Guidance:** Advice on web technologies and best practices
üé® **UI/UX Design:** Modern, responsive interface recommendations
‚ö° **Code Solutions:** Specific implementations and features

Would you like me to:
1. Create a new app for you? (40 credits)
2. Answer a specific development question? (5 credits)
3. Provide guidance on a particular feature?

Just let me know what you'd like to build or learn! üöÄ`;
        }

        async function generateEnhancedApp(description) {
            // Enhanced app generation with templates and customization
            const appName = extractAppName(description);
            const appType = detectAppType(description);
            const theme = detectTheme(description);
            const features = detectFeatures(description);
            
            return generateAppTemplate(appName, appType, theme, features, description);
        }

        function generateAppTemplate(name, type, theme, features, description) {
            const isDark = theme === 'dark';
            const primaryColor = extractColor(description) || '#7C3AED';
            
            const templates = {
                social: generateSocialMediaApp(name, primaryColor, isDark, features),
                recipe: generateRecipeApp(name, primaryColor, isDark, features),
                news: generateNewsApp(name, primaryColor, isDark, features),
                weather: generateWeatherApp(name, primaryColor, isDark, features),
                business: generateBusinessApp(name, primaryColor, isDark, features),
                portfolio: generatePortfolioApp(name, primaryColor, isDark, features),
                ecommerce: generateEcommerceApp(name, primaryColor, isDark, features),
                blog: generateBlogApp(name, primaryColor, isDark, features),
                dashboard: generateDashboardApp(name, primaryColor, isDark, features),
                default: generateDefaultApp(name, primaryColor, isDark, features)
            };
            
            return templates[type] || templates.default;
        }

        // =============================================
        // APP GENERATION TEMPLATES - COMPLETELY FIXED
        // =============================================
        function generateSocialMediaApp(name, primaryColor, isDark, features) {
            const bgColor = isDark ? '#0f0f0f' : '#ffffff';
            const textColor = isDark ? '#ffffff' : '#0f0f0f';
            const cardBg = isDark ? '#1a1a1a' : '#f8f9fa';
            
            return `
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${name} - Social Network</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        }
        
        body {
            background: ${bgColor};
            color: ${textColor};
            line-height: 1.6;
            min-height: 100vh;
        }
        
        .navbar {
            background: ${primaryColor};
            color: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .logo {
            font-size: 1.5rem;
            font-weight: 700;
        }
        
        .nav-icons {
            display: flex;
            gap: 1.5rem;
            font-size: 1.2rem;
        }
        
        .container {
            max-width: 600px;
            margin: 2rem auto;
            padding: 0 1rem;
        }
        
        .create-post {
            background: ${cardBg};
            padding: 1.5rem;
            border-radius: 15px;
            margin-bottom: 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .post-input {
            width: 100%;
            background: ${isDark ? '#262626' : '#ffffff'};
            border: 1px solid ${isDark ? '#374151' : '#e5e7eb'};
            border-radius: 10px;
            padding: 1rem;
            color: ${textColor};
            resize: none;
            margin-bottom: 1rem;
            font-size: 1rem;
        }
        
        .post-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .action-buttons {
            display: flex;
            gap: 1rem;
        }
        
        .icon-btn {
            background: none;
            border: none;
            color: ${textColor};
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 8px;
            transition: all 0.3s ease;
            font-size: 1.2rem;
        }
        
        .icon-btn:hover {
            background: ${isDark ? '#374151' : '#f3f4f6'};
        }
        
        .post-btn {
            background: ${primaryColor};
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .post-btn:hover {
            background: ${primaryColor}dd;
            transform: translateY(-2px);
        }
        
        .feed {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        
        .post {
            background: ${cardBg};
            padding: 1.5rem;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .post-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: ${primaryColor};
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
        
        .user-info h4 {
            margin-bottom: 0.25rem;
            font-size: 1rem;
        }
        
        .post-time {
            color: ${isDark ? '#9ca3af' : '#6b7280'};
            font-size: 0.875rem;
        }
        
        .post-content {
            margin-bottom: 1rem;
            font-size: 1rem;
            line-height: 1.5;
        }
        
        .post-engagement {
            display: flex;
            justify-content: space-between;
            color: ${isDark ? '#9ca3af' : '#6b7280'};
            font-size: 0.9rem;
        }
        
        .engagement-stats {
            display: flex;
            gap: 1rem;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 0 0.5rem;
            }
            
            .navbar {
                padding: 1rem;
            }
            
            .nav-icons {
                gap: 1rem;
            }
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="logo">${name}</div>
        <div class="nav-icons">
            <span>üè†</span>
            <span>üîç</span>
            <span>‚ûï</span>
            <span>üí¨</span>
            <span>üë§</span>
        </div>
    </nav>
    
    <div class="container">
        <div class="create-post">
            <textarea class="post-input" placeholder="What's on your mind?"></textarea>
            <div class="post-actions">
                <div class="action-buttons">
                    <button class="icon-btn">üì∑</button>
                    <button class="icon-btn">üé•</button>
                    <button class="icon-btn">üìÑ</button>
                </div>
                <button class="post-btn">Post</button>
            </div>
        </div>
        
        <div class="feed">
            <div class="post">
                <div class="post-header">
                    <div class="avatar">AJ</div>
                    <div class="user-info">
                        <h4>Alex Johnson</h4>
                        <div class="post-time">2 hours ago</div>
                    </div>
                </div>
                <div class="post-content">
                    <p>Just launched my new portfolio website! Built with modern web technologies and responsive design. üöÄ</p>
                </div>
                <div class="post-engagement">
                    <div class="engagement-stats">
                        <span>üëç 24</span>
                        <span>üí¨ 8</span>
                        <span>üîÑ 3</span>
                    </div>
                    <span>üîó</span>
                </div>
            </div>
            
            <div class="post">
                <div class="post-header">
                    <div class="avatar">SC</div>
                    <div class="user-info">
                        <h4>Sarah Chen</h4>
                        <div class="post-time">5 hours ago</div>
                    </div>
                </div>
                <div class="post-content">
                    <p>Beautiful sunset from the office today! Sometimes you need to appreciate the small moments. üåÖ</p>
                </div>
                <div class="post-engagement">
                    <div class="engagement-stats">
                        <span>üëç 42</span>
                        <span>üí¨ 12</span>
                        <span>üîÑ 5</span>
                    </div>
                    <span>üîó</span>
                </div>
            </div>
        </div>
    </div>
</body>
</html>`;
        }

        function generateWeatherApp(name, primaryColor, isDark, features) {
            const bgColor = isDark ? '#0f172a' : '#f0f9ff';
            const textColor = isDark ? '#f8fafc' : '#0f172a';
            const cardBg = isDark ? '#1e293b' : '#ffffff';
            
            return `
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${name} - Weather</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        }
        
        body {
            background: ${bgColor};
            color: ${textColor};
            line-height: 1.6;
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 2rem 1rem;
        }
        
        .header {
            text-align: center;
            margin-bottom: 2rem;
        }
        
        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            color: white;
        }
        
        .header p {
            color: rgba(255,255,255,0.8);
            font-size: 1.1rem;
        }
        
        .search-bar {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border-radius: 25px;
            padding: 1rem 1.5rem;
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        .search-input {
            flex: 1;
            background: transparent;
            border: none;
            color: white;
            font-size: 1rem;
            outline: none;
        }
        
        .search-input::placeholder {
            color: rgba(255,255,255,0.6);
        }
        
        .search-btn {
            background: ${primaryColor};
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 600;
        }
        
        .current-weather {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 2rem;
            margin-bottom: 2rem;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        .temperature {
            font-size: 4rem;
            font-weight: 300;
            margin: 1rem 0;
        }
        
        .weather-icon {
            font-size: 4rem;
            margin: 1rem 0;
        }
        
        .description {
            font-size: 1.5rem;
            margin-bottom: 1rem;
            opacity: 0.9;
        }
        
        .details {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin-top: 2rem;
        }
        
        .detail-item {
            background: rgba(255,255,255,0.1);
            padding: 1rem;
            border-radius: 15px;
            text-align: center;
        }
        
        .detail-value {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        
        .detail-label {
            font-size: 0.9rem;
            opacity: 0.8;
        }
        
        .forecast {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
            margin-top: 2rem;
        }
        
        .forecast-day {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 1rem;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        .day-name {
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        
        .day-icon {
            font-size: 2rem;
            margin: 0.5rem 0;
        }
        
        .day-temp {
            font-weight: 600;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }
            
            .details {
                grid-template-columns: 1fr 1fr;
            }
            
            .forecast {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .temperature {
                font-size: 3rem;
            }
        }
        
        @media (max-width: 480px) {
            .details {
                grid-template-columns: 1fr;
            }
            
            .forecast {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>${name}</h1>
            <p>Real-time weather forecasts</p>
        </div>
        
        <div class="search-bar">
            <input type="text" class="search-input" placeholder="Search for a city...">
            <button class="search-btn">Search</button>
        </div>
        
        <div class="current-weather">
            <div class="weather-icon">üå§Ô∏è</div>
            <div class="temperature">22¬∞C</div>
            <div class="description">Partly Cloudy</div>
            <div class="location">Berlin, Germany</div>
            
            <div class="details">
                <div class="detail-item">
                    <div class="detail-value">65%</div>
                    <div class="detail-label">Humidity</div>
                </div>
                <div class="detail-item">
                    <div class="detail-value">15 km/h</div>
                    <div class="detail-label">Wind</div>
                </div>
                <div class="detail-item">
                    <div class="detail-value">1013 hPa</div>
                    <div class="detail-label">Pressure</div>
                </div>
            </div>
        </div>
        
        <div class="forecast">
            <div class="forecast-day">
                <div class="day-name">Mon</div>
                <div class="day-icon">‚òÄÔ∏è</div>
                <div class="day-temp">24¬∞</div>
            </div>
            <div class="forecast-day">
                <div class="day-name">Tue</div>
                <div class="day-icon">üå§Ô∏è</div>
                <div class="day-temp">23¬∞</div>
            </div>
            <div class="forecast-day">
                <div class="day-name">Wed</div>
                <div class="day-icon">üåßÔ∏è</div>
                <div class="day-temp">19¬∞</div>
            </div>
            <div class="forecast-day">
                <div class="day-name">Thu</div>
                <div class="day-icon">‚õàÔ∏è</div>
                <div class="day-temp">18¬∞</div>
            </div>
            <div class="forecast-day">
                <div class="day-name">Fri</div>
                <div class="day-icon">üå¶Ô∏è</div>
                <div class="day-temp">21¬∞</div>
            </div>
        </div>
    </div>
</body>
</html>`;
        }

        function generateFallbackApp(description) {
            const appName = extractAppName(description);
            const isDark = description.toLowerCase().includes('dark');
            
            return `
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${appName}</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        }
        
        body {
            background: ${isDark ? '#0f0f0f' : '#ffffff'};
            color: ${isDark ? '#ffffff' : '#0f0f0f'};
            min-height: 100vh;
            line-height: 1.6;
        }
        
        .app-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        .header {
            text-align: center;
            padding: 4rem 2rem;
            background: linear-gradient(135deg, #7C3AED, #10B981);
            color: white;
            border-radius: 20px;
            margin-bottom: 3rem;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 1rem;
        }
        
        .features {
            display: grid;
            gap: 2rem;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        }
        
        .feature-card {
            background: ${isDark ? '#1a1a1a' : '#f8f9fa'};
            padding: 2.5rem;
            border-radius: 15px;
            border-left: 4px solid #7C3AED;
            transition: all 0.3s ease;
        }
        
        .feature-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        
        .feature-card h3 {
            color: #7C3AED;
            margin-bottom: 1rem;
            font-size: 1.25rem;
        }
        
        .feature-card p {
            line-height: 1.5;
        }
        
        .footer {
            text-align: center;
            margin-top: 4rem;
            padding: 2rem;
            color: ${isDark ? '#9ca3af' : '#6b7280'};
            font-size: 0.875rem;
        }
        
        @media (max-width: 768px) {
            .app-container {
                padding: 1rem;
            }
            
            .header {
                padding: 3rem 1rem;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .features {
                grid-template-columns: 1fr;
            }
            
            .feature-card {
                padding: 2rem;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="header">
            <h1>${appName}</h1>
            <p>Created with PartexAI - AI App Builder</p>
        </div>
        
        <div class="features">
            <div class="feature-card">
                <h3>‚ú® Modern Design</h3>
                <p>This app features a contemporary design with responsive layout that works perfectly on all devices.</p>
            </div>
            <div class="feature-card">
                <h3>üöÄ Fast Performance</h3>
                <p>Optimized for speed and efficiency with clean code and modern web standards.</p>
            </div>
            <div class="feature-card">
                <h3>üéØ Customizable</h3>
                <p>Easily customize this template to fit your specific needs and requirements.</p>
            </div>
        </div>
        
        <div class="footer">
            <p>Generated by PartexAI - Your AI App Development Partner</p>
        </div>
    </div>
</body>
</html>`;
        }

        // =============================================
        // UTILITY FUNCTIONS
        // =============================================
        function extractAppName(description) {
            const match = description.match(/"([^"]+)"/);
            return match ? match[1] : 'My Awesome App';
        }

        function extractColor(description) {
            const colorMatch = description.match(/#([a-f0-9]{6}|[a-f0-9]{3})/i);
            return colorMatch ? colorMatch[0] : null;
        }

        function detectAppType(description) {
            const lowerDesc = description.toLowerCase();
            if (lowerDesc.includes('social') || lowerDesc.includes('media')) return 'social';
            if (lowerDesc.includes('recipe') || lowerDesc.includes('food')) return 'recipe';
            if (lowerDesc.includes('news') || lowerDesc.includes('blog')) return 'news';
            if (lowerDesc.includes('weather') || lowerDesc.includes('forecast')) return 'weather';
            if (lowerDesc.includes('business') || lowerDesc.includes('corporate')) return 'business';
            if (lowerDesc.includes('portfolio') || lowerDesc.includes('showcase')) return 'portfolio';
            if (lowerDesc.includes('ecommerce') || lowerDesc.includes('shop') || lowerDesc.includes('store')) return 'ecommerce';
            if (lowerDesc.includes('dashboard') || lowerDesc.includes('analytics')) return 'dashboard';
            return 'default';
        }

        function detectTheme(description) {
            return description.toLowerCase().includes('light') ? 'light' : 'dark';
        }

        function detectFeatures(description) {
            const features = [];
            const lowerDesc = description.toLowerCase();
            
            if (lowerDesc.includes('responsive') || lowerDesc.includes('mobile')) features.push('responsive');
            if (lowerDesc.includes('animation') || lowerDesc.includes('interactive')) features.push('animations');
            if (lowerDesc.includes('search') || lowerDesc.includes('filter')) features.push('search');
            if (lowerDesc.includes('user') || lowerDesc.includes('account')) features.push('authentication');
            
            return features;
        }

        // =============================================
        // UI INTERACTION FUNCTIONS - COMPLETELY FIXED
        // =============================================
        function showCustomInput() {
            const section = document.getElementById('customInputSection');
            section.style.display = section.style.display === 'none' ? 'block' : 'none';
        }

        function selectTemplate(templateType) {
            if (userCredits < APP_COST) {
                showInsufficientCredits();
                return;
            }

            const templates = {
                'social': 'Create a modern social media app with stories, posts, likes and comments. With dark design and responsive interface.',
                'recipe': 'Create a recipe app with categories, favorites, shopping list and search function. Including nutritional information.',
                'news': 'Create a news reader with personalized feeds, categories, bookmarks and offline functionality.',
                'weather': 'Create a modern weather app with animated icons, 7-day forecast, city search, and real-time weather data display in dark theme with gradient backgrounds.'
            };
            
            document.getElementById('messageInput').value = templates[templateType];
            addMessage(templates[templateType], 'user');
            sendMessage(true);
        }

        function generateCustomApp() {
            if (userCredits < APP_COST) {
                showInsufficientCredits();
                return;
            }

            const appName = document.getElementById('appName').value;
            const appType = document.getElementById('appType').value;
            const primaryColor = document.getElementById('primaryColor').value;
            const layoutType = document.getElementById('layoutType').value;
            const themeType = document.getElementById('themeType').value;
            const frameworkType = document.getElementById('frameworkType').value;
            const darkMode = document.getElementById('darkModeToggle').checked;
            const responsive = document.getElementById('responsiveToggle').checked;
            const animations = document.getElementById('animationsToggle').checked;
            const seo = document.getElementById('seoToggle').checked;

            const customDescription = `Create a ${appType} app named "${appName}" with ${layoutType} layout, ${themeType} theme, ${frameworkType} framework, primary color ${primaryColor}. Features: ${darkMode ? 'dark mode' : 'light mode'}, ${responsive ? 'responsive design' : 'fixed layout'}, ${animations ? 'with animations' : 'no animations'}, ${seo ? 'SEO optimized' : 'basic SEO'}.`;

            document.getElementById('messageInput').value = customDescription;
            addMessage(customDescription, 'user');
            sendMessage(true);
            
            document.getElementById('customInputSection').style.display = 'none';
        }

        function showInsufficientCredits() {
            addMessage(`‚ùå Insufficient credits! You only have ${userCredits} credits. Each app costs ${APP_COST} credits, chat costs ${CHAT_COST} credits. Daily reset to ${DAILY_CREDITS} credits.`, 'ai');
        }

        // =============================================
        // MESSAGE HANDLING SYSTEM - COMPLETELY FIXED
        // =============================================
        function addMessage(text, sender) {
            const messagesContainer = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            
            messageDiv.innerHTML = `
                <div class="message-avatar">${sender === 'user' ? 'U' : 'AI'}</div>
                <div class="message-content">
                    <p class="message-text">${text.replace(/\n/g, '<br>')}</p>
                </div>
            `;
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        async function sendMessage(isAppRequestOverride = false) {
            if (isProcessing) {
                addMessage("‚è≥ Please wait for the current request to complete...", 'ai');
                return;
            }

            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (!message) {
                addMessage("‚ùå Please enter a message before sending.", 'ai');
                return;
            }

            const isApp = isAppRequestOverride || isAppRequest(message);
            const cost = isApp ? APP_COST : CHAT_COST;

            // Check credits
            if (userCredits < cost) {
                showInsufficientCredits();
                return;
            }

            // Reset UI
            input.value = '';
            const sendBtn = document.getElementById('sendBtn');
            sendBtn.disabled = true;
            sendBtn.innerHTML = isApp ? '<span>Creating...</span><span>‚ö°</span>' : '<span>Thinking...</span><span>üí≠</span>';

            // Add user message
            addMessage(message, 'user');

            // Deduct credits
            await updateCredits(-cost);

            if (isApp) {
                // Show progress for app generation
                showProgress();
            }

            try {
                let response;
                if (isApp) {
                    // Use AI for app generation
                    response = await simulateAIProcessing(message);
                    await addToHistory(message, response, true);
                } else {
                    // Use AI for normal chat
                    response = await callGeminiAI(message, false);
                    addMessage(response, 'ai');
                    await addToHistory(message, response, false);
                }
                
            } catch (error) {
                console.error('‚ùå Error:', error);
                addMessage('‚ùå Sorry, there was an error processing your request. Your credits have been refunded.', 'ai');
                // Refund credits
                await updateCredits(cost);
            } finally {
                sendBtn.disabled = false;
                sendBtn.innerHTML = '<span>Send</span><span>üöÄ</span>';
                if (isApp) {
                    hideProgress();
                }
            }
        }

        function isAppRequest(message) {
            const appKeywords = ['app', 'website', 'create', 'build', 'make', 'design', 'develop', 'application', 'webapp', 'site', 'template'];
            const lowerMessage = message.toLowerCase();
            return appKeywords.some(keyword => lowerMessage.includes(keyword));
        }

        // =============================================
        // PROGRESS & PREVIEW SYSTEM - COMPLETELY FIXED
        // =============================================
        async function simulateAIProcessing(message) {
            const steps = [
                { progress: 10, text: "üìã Analyzing your requirements..." },
                { progress: 25, text: "üõ†Ô∏è Planning application architecture..." },
                { progress: 40, text: "üé® Designing user interface..." },
                { progress: 60, text: "‚ö° Implementing core features..." },
                { progress: 75, text: "üîß Adding interactive elements..." },
                { progress: 90, text: "üéØ Finalizing app structure..." },
                { progress: 100, text: "‚úÖ App successfully generated!" }
            ];

            for (let i = 0; i < steps.length; i++) {
                const step = steps[i];
                updateProgress(step.progress);
                addMessage(step.text, 'ai');
                
                // Update live preview at certain stages
                if (i === 2 || i === 4) {
                    updateLivePreview(i, message);
                }
                
                await new Promise(resolve => setTimeout(resolve, 800));
            }

            // Generate actual app HTML using AI
            const generatedApp = await callGeminiAI(message, true);
            displayGeneratedApp(generatedApp);
            
            // Show download options
            document.getElementById('downloadBtn').style.display = 'flex';
            document.getElementById('scaleControls').style.display = 'flex';

            // Final message
            addMessage(`üéâ Your app has been successfully generated! You can now see it in the live preview and download the HTML file. (${APP_COST} credits used)`, 'ai');

            return generatedApp;
        }

        function updateProgress(percent) {
            document.getElementById('progressSection').style.display = 'block';
            document.getElementById('progressFill').style.width = percent + '%';
            document.getElementById('progressText').textContent = percent + '%';
        }

        function showProgress() {
            document.getElementById('progressSection').style.display = 'block';
            document.getElementById('progressFill').style.width = '0%';
            document.getElementById('progressText').textContent = '0%';
        }

        function hideProgress() {
            setTimeout(() => {
                document.getElementById('progressSection').style.display = 'none';
            }, 1000);
        }

        function updateLivePreview(step, message) {
            const previews = [
                `<div class="preview-header">
                    <h4>Planning Stage</h4>
                    <p>Analyzing your app requirements...</p>
                </div>
                <div class="preview-content">
                    <div class="preview-placeholder"></div>
                </div>`,
                `<div class="preview-header">
                    <h4>Design Phase</h4>
                    <p>Creating beautiful interface designs...</p>
                </div>
                <div class="preview-content">
                    <div class="preview-placeholder"></div>
                    <div class="preview-placeholder"></div>
                </div>`,
                `<div class="preview-header">
                    <h4>Development</h4>
                    <p>Building app components...</p>
                </div>
                <div class="preview-content">
                    <div class="preview-item">Header Component</div>
                    <div class="preview-item">Navigation Menu</div>
                    <div class="preview-item">Content Sections</div>
                </div>`,
                `<div class="preview-header">
                    <h4>Final Touches</h4>
                    <p>Adding finishing touches...</p>
                </div>
                <div class="preview-content">
                    <div class="preview-item">Responsive Layout</div>
                    <div class="preview-item">Interactive Elements</div>
                    <div class="preview-item">Color Scheme</div>
                    <div class="preview-item">Typography</div>
                </div>`
            ];

            if (step < previews.length) {
                const preview = document.getElementById('appPreview');
                preview.innerHTML = previews[step];
            }
        }

        function displayGeneratedApp(appHtml) {
            const preview = document.getElementById('generatedApp');
            preview.innerHTML = appHtml;
            currentGeneratedApp = appHtml;
            
            // Apply scaling
            setScale(currentScale);
        }

        function setScale(scale) {
            currentScale = scale;
            const generatedApp = document.getElementById('generatedApp');
            if (generatedApp) {
                generatedApp.style.transform = `scale(${scale})`;
                generatedApp.style.transformOrigin = 'top left';
                generatedApp.style.width = `${100/scale}%`;
                generatedApp.style.height = `${100/scale}%`;
            }
            
            // Update active button
            document.querySelectorAll('.scale-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
        }

        function downloadApp() {
            if (!currentGeneratedApp) {
                addMessage("‚ùå No app generated yet. Please create an app first.", 'ai');
                return;
            }
            
            const blob = new Blob([currentGeneratedApp], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'my-app.html';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            addMessage("üì• App downloaded successfully! You can now open the HTML file in any browser.", 'ai');
        }

        // =============================================
        // HISTORY MANAGEMENT
        // =============================================
        async function addToHistory(description, code, isApp = true) {
            if (!currentUser) return;
            
            const historyItem = {
                id: Date.now(),
                description: description,
                code: code,
                date: new Date().toISOString(),
                completed: true,
                isApp: isApp,
                creditsUsed: isApp ? APP_COST : CHAT_COST
            };
            
            userHistory.unshift(historyItem);
            
            // Keep only last 10 items
            if (userHistory.length > 10) {
                userHistory = userHistory.slice(0, 10);
            }
            
            try {
                await database.ref('users/' + currentUser.uid).update({
                    history: userHistory
                });
                updateHistoryDisplay();
            } catch (error) {
                console.error('‚ùå Error saving history:', error);
            }
        }

        function updateHistoryDisplay() {
            const historyList = document.getElementById('historyList');
            historyList.innerHTML = '';
            
            if (userHistory.length === 0) {
                historyList.innerHTML = `
                    <div class="history-item" onclick="loadExampleProject()">
                        <h4>üì± Social Media Template</h4>
                        <p>Modern social media app with dark theme</p>
                        <div class="history-date">Example Project</div>
                    </div>
                    <p style="color: var(--text-secondary); text-align: center; margin-top: 1rem; font-size: 0.875rem;">
                        Your generated projects will appear here
                    </p>
                `;
                return;
            }
            
            userHistory.forEach(item => {
                const historyItem = document.createElement('div');
                historyItem.className = 'history-item';
                historyItem.onclick = () => loadHistoryItem(item);
                
                const date = new Date(item.date).toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                const description = item.description.length > 60 ? 
                    item.description.substring(0, 60) + '...' : item.description;
                const typeIcon = item.isApp ? 'üì±' : 'üí¨';
                const creditsText = item.isApp ? `${APP_COST}‚ö°` : `${CHAT_COST}‚ö°`;
                
                historyItem.innerHTML = `
                    <h4>${typeIcon} ${description}</h4>
                    <p>‚úÖ Completed ‚Ä¢ ${creditsText}</p>
                    <div class="history-date">${date}</div>
                `;
                
                historyList.appendChild(historyItem);
            });
        }

        function loadHistoryItem(item) {
            if (item.isApp) {
                document.getElementById('messageInput').value = item.description;
                displayGeneratedApp(item.code);
                addMessage(`üìÅ Loaded project: "${item.description}"`, 'ai');
            } else {
                document.getElementById('messageInput').value = item.description;
                addMessage(`üí¨ Loaded conversation: "${item.description}"`, 'ai');
            }
        }

        function loadExampleProject() {
            const exampleDescription = "Create a modern social media app with dark theme, posts, likes, and comments";
            document.getElementById('messageInput').value = exampleDescription;
            addMessage("üìã Example project loaded. Click 'Send' to generate this social media app!", 'ai');
        }

        async function clearHistory() {
            if (!currentUser) return;
            
            if (userHistory.length === 0) {
                addMessage("‚ÑπÔ∏è History is already empty.", 'ai');
                return;
            }
            
            userHistory = [];
            try {
                await database.ref('users/' + currentUser.uid).update({
                    history: []
                });
                updateHistoryDisplay();
                addMessage("üóëÔ∏è History cleared successfully.", 'ai');
            } catch (error) {
                console.error('‚ùå Error clearing history:', error);
                addMessage("‚ùå Error clearing history. Please try again.", 'ai');
            }
        }

        // =============================================
        // ADDITIONAL TEMPLATE GENERATORS
        // =============================================
        function generateNewsApp(name, primaryColor, isDark, features) {
            return generateDefaultApp(name, primaryColor, isDark, features);
        }

        function generateRecipeApp(name, primaryColor, isDark, features) {
            return generateDefaultApp(name, primaryColor, isDark, features);
        }

        function generateBusinessApp(name, primaryColor, isDark, features) {
            return generateDefaultApp(name, primaryColor, isDark, features);
        }

        function generatePortfolioApp(name, primaryColor, isDark, features) {
            return generateDefaultApp(name, primaryColor, isDark, features);
        }

        function generateEcommerceApp(name, primaryColor, isDark, features) {
            return generateDefaultApp(name, primaryColor, isDark, features);
        }

        function generateBlogApp(name, primaryColor, isDark, features) {
            return generateDefaultApp(name, primaryColor, isDark, features);
        }

        function generateDashboardApp(name, primaryColor, isDark, features) {
            return generateDefaultApp(name, primaryColor, isDark, features);
        }

        function generateDefaultApp(name, primaryColor, isDark, features) {
            return generateFallbackApp(`Create a ${name} app`);
        }

        // =============================================
        // INITIALIZATION & EVENT LISTENERS
        // =============================================
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize color picker sync
            const colorPicker = document.getElementById('colorPicker');
            const colorInput = document.getElementById('primaryColor');
            
            colorPicker.addEventListener('input', function(e) {
                colorInput.value = e.target.value;
            });

            colorInput.addEventListener('input', function(e) {
                if (e.target.value.match(/^#[0-9A-F]{6}$/i)) {
                    colorPicker.value = e.target.value;
                }
            });

            // Enter key support for message input
            document.getElementById('messageInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            // Auto-resize textarea
            document.getElementById('messageInput').addEventListener('input', function(e) {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 120) + 'px';
            });

            // Demo mode - auto login for testing
            setTimeout(() => {
                if (!currentUser) {
                    document.getElementById('authContainer').style.display = 'none';
                    document.getElementById('appContainer').style.display = 'block';
                    updateCreditsDisplay();
                    updateHistoryDisplay();
                    console.log('üöÄ PartexAI loaded in demo mode');
                }
            }, 1000);

            console.log('üéâ PartexAI initialized successfully!');
        });

    </script>
</body>
</html>
